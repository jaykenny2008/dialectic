<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Dialectic â€” Reading Companion</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:opsz,wght@8..60,400;8..60,600;8..60,700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --font-display: 'Source Serif 4', Georgia, serif;
  --font-body: 'DM Sans', -apple-system, sans-serif;
  --bg: #0F0F0F;
  --bg2: #1A1A1A;
  --fg: #E8E4DF;
  --muted: #8A8580;
  --border: #2A2725;
  --accent: #C4915E;
  --accent-bg: rgba(196,145,94,0.12);
  --green: #5CB85C;
  --green-bg: rgba(92,184,92,0.15);
  --red: #D9534F;
  --red-bg: rgba(217,83,79,0.15);
  --amber: #D4A843;
  --amber-bg: rgba(212,168,67,0.15);
  --radius: 12px;
  --nav-h: 64px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; }
body {
  font-family: var(--font-body);
  background: var(--bg);
  color: var(--fg);
  -webkit-font-smoothing: antialiased;
  overflow-x: hidden;
}

/* â”€â”€ Shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.shell { max-width: 480px; margin: 0 auto; min-height: 100vh; position: relative; padding-bottom: calc(var(--nav-h) + 16px); }

/* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.hdr {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 20px; border-bottom: 1px solid var(--border);
  position: sticky; top: 0; background: var(--bg); z-index: 100;
}
.hdr-title { font: 700 18px/1 var(--font-display); color: var(--fg); letter-spacing: -0.01em; }
.hdr-back {
  background: none; border: none; color: var(--accent); font-size: 22px;
  cursor: pointer; padding: 4px 8px; font-family: inherit;
}
.hdr-settings {
  background: none; border: none; color: var(--muted); font-size: 18px;
  cursor: pointer; padding: 4px 8px;
}

/* â”€â”€ Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.nav {
  position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
  width: 100%; max-width: 480px;
  display: flex; justify-content: space-around; align-items: center;
  padding: 6px 0 max(env(safe-area-inset-bottom, 8px), 8px);
  background: var(--bg); border-top: 1px solid var(--border); z-index: 100;
}
.nav-btn {
  display: flex; flex-direction: column; align-items: center;
  padding: 4px 14px; background: none; border: none;
  cursor: pointer; font-family: inherit; color: var(--muted); transition: color 0.2s;
}
.nav-btn.active { color: var(--fg); }
.nav-btn.accent-btn { color: var(--accent); }
.nav-btn .icon { font-size: 20px; line-height: 1; }
.nav-btn.accent-btn .icon { font-size: 26px; }
.nav-btn .label { font-size: 10px; margin-top: 2px; letter-spacing: 0.05em; text-transform: uppercase; }

/* â”€â”€ Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.content { padding: 20px 20px 0; }
.view { display: none; }
.view.active { display: block; }

/* â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card {
  background: var(--bg2); border-radius: var(--radius);
  padding: 18px; margin-bottom: 14px; border: 1px solid var(--border);
}
.card-label {
  font-size: 12px; color: var(--muted); text-transform: uppercase;
  letter-spacing: 0.08em; margin-bottom: 4px; font-weight: 600;
}

/* â”€â”€ Progress â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.progress-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.progress-big { font: 700 32px/1.1 var(--font-display); color: var(--fg); }
.progress-sub { font-size: 16px; color: var(--muted); font-weight: 400; }
.progress-ring {
  width: 56px; height: 56px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font: 700 14px var(--font-display);
}
.track { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
.fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
.streak { margin-top: 10px; font-size: 13px; color: var(--muted); }

/* â”€â”€ Action Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
.action-card {
  background: var(--bg2); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 18px 14px; display: flex; flex-direction: column; align-items: center; gap: 2px;
  cursor: pointer; font-family: inherit; transition: border-color 0.2s;
}
.action-card:hover { border-color: var(--accent); }
.action-card .emoji { font-size: 24px; margin-bottom: 4px; }
.action-card .title { font-size: 13px; font-weight: 600; color: var(--fg); }
.action-card .sub { font-size: 11px; color: var(--muted); }

/* â”€â”€ Section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.section-title { font: 700 14px var(--font-display); color: var(--fg); }
.link-btn { background: none; border: none; color: var(--accent); font-size: 12px; font-weight: 600; cursor: pointer; font-family: inherit; }

/* â”€â”€ Empty â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty { text-align: center; padding: 48px 20px; }
.empty .emoji { font-size: 40px; margin-bottom: 12px; }
.empty .title { font-size: 15px; font-weight: 600; color: var(--fg); margin-bottom: 4px; }
.empty .sub { font-size: 13px; color: var(--muted); }

/* â”€â”€ Note Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.note-card {
  background: var(--bg2); border-radius: var(--radius); padding: 14px;
  margin-bottom: 10px; border: 1px solid var(--border); cursor: pointer; transition: border-color 0.2s;
}
.note-card:hover { border-color: var(--accent); }
.note-meta { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
.note-meta .type { font-size: 14px; }
.note-meta .date { font-size: 12px; color: var(--muted); }
.badge { font-size: 10px; background: var(--accent-bg); color: var(--accent); padding: 1px 6px; border-radius: 8px; font-weight: 600; }
.note-book { font-size: 13px; font-weight: 600; color: var(--fg); margin-bottom: 2px; }
.note-preview {
  font-size: 13px; color: var(--muted); line-height: 1.5;
  overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
}
.del-btn { background: none; border: none; color: var(--muted); font-size: 20px; cursor: pointer; padding: 0 4px; line-height: 1; }

/* â”€â”€ Toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toggle-wrap {
  display: flex; background: var(--bg2); border-radius: var(--radius);
  padding: 4px; margin-bottom: 14px; border: 1px solid var(--border);
}
.toggle-btn {
  flex: 1; padding: 10px 0; border: none; border-radius: 8px; font-size: 14px;
  font-weight: 600; cursor: pointer; background: transparent; color: var(--muted);
  font-family: inherit; transition: all 0.2s;
}
.toggle-btn.active { background: var(--accent-bg); color: var(--accent); }

/* â”€â”€ Inputs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.input-label {
  display: block; font-size: 12px; font-weight: 600; color: var(--muted);
  text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 6px;
}
.input {
  width: 100%; padding: 10px 14px; border-radius: 8px;
  border: 1px solid var(--border); background: var(--bg); color: var(--fg);
  font-size: 14px; font-family: inherit; outline: none;
}
.input:focus { border-color: var(--accent); }
.textarea {
  width: 100%; padding: 14px; border-radius: 8px;
  border: 1px solid var(--border); background: var(--bg); color: var(--fg);
  font-size: 14px; font-family: inherit; outline: none; resize: vertical;
  line-height: 1.6; min-height: 160px;
}
.textarea:focus { border-color: var(--accent); }
input[type="range"] { height: 4px; -webkit-appearance: none; background: var(--border); border-radius: 2px; outline: none; width: 100%; }
input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--accent); cursor: pointer; }

/* â”€â”€ Record Button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.rec-btn {
  width: 72px; height: 72px; border-radius: 50%; border: none;
  color: #fff; font-size: 28px; cursor: pointer;
  display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s;
}
.rec-btn.recording { animation: pulse 1.5s infinite; }
@keyframes pulse {
  0%,100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(217,83,79,0.5); }
  50% { transform: scale(1.05); box-shadow: 0 0 0 12px rgba(217,83,79,0); }
}

.transcript-box { background: var(--bg); border-radius: 8px; padding: 14px; border: 1px solid var(--border); }
.transcript-label { font-size: 11px; color: var(--muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.08em; }
.transcript-text { font-size: 14px; line-height: 1.6; color: var(--fg); }

.error-box { background: var(--red-bg); border: 1px solid var(--red); border-radius: 8px; padding: 12px; margin-bottom: 14px; font-size: 13px; color: var(--red); line-height: 1.5; }

/* â”€â”€ Feedback Toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.fb-toggle {
  width: 48px; height: 26px; border-radius: 13px; border: none;
  cursor: pointer; position: relative; transition: background 0.2s; flex-shrink: 0;
}
.fb-toggle .knob {
  width: 22px; height: 22px; border-radius: 50%; background: #fff;
  position: absolute; top: 2px; transition: transform 0.2s;
}
.fb-toggle.on { background: var(--accent); }
.fb-toggle.on .knob { transform: translateX(22px); }
.fb-toggle.off { background: var(--border); }
.fb-toggle.off .knob { transform: translateX(2px); }

/* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.primary-btn {
  width: 100%; padding: 14px 0; border-radius: var(--radius); border: none;
  background: var(--accent); color: #fff; font-size: 15px; font-weight: 700;
  cursor: pointer; font-family: inherit; margin-bottom: 14px; transition: opacity 0.2s;
}
.primary-btn:disabled { opacity: 0.4; cursor: default; }
.secondary-btn {
  width: 100%; padding: 14px 0; border-radius: var(--radius);
  border: 1px solid var(--border); background: var(--bg2); color: var(--fg);
  font-size: 15px; font-weight: 600; cursor: pointer; font-family: inherit; margin-bottom: 14px;
}
.btn-row { display: flex; gap: 10px; }
.btn-row > * { flex: 1; }

/* â”€â”€ Saved State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.saved-card { border-left: 3px solid var(--green); }
.feedback-card { border-left: 3px solid var(--accent); }
.feedback-label {
  font-size: 12px; text-transform: uppercase; letter-spacing: 0.08em;
  color: var(--accent); margin-bottom: 8px; font-weight: 600;
}
.feedback-text { font-size: 14px; line-height: 1.7; color: var(--fg); white-space: pre-wrap; }

/* â”€â”€ Calendar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cal-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.cal-nav-btn {
  background: none; border: 1px solid var(--border); color: var(--fg);
  width: 36px; height: 36px; border-radius: 8px; font-size: 18px; cursor: pointer;
  display: flex; align-items: center; justify-content: center; font-family: inherit;
}
.cal-month { font: 700 18px var(--font-display); color: var(--fg); }
.stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
.stat { background: var(--bg2); border-radius: var(--radius); padding: 14px 10px; text-align: center; border: 1px solid var(--border); }
.stat-val { font: 700 24px var(--font-display); color: var(--fg); }
.stat-label { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; margin-top: 2px; }
.cal-grid { display: grid; grid-template-columns: repeat(7,1fr); gap: 4px; }
.cal-hdr { font-size: 10px; font-weight: 600; color: var(--muted); text-align: center; padding: 4px 0; text-transform: uppercase; letter-spacing: 0.05em; }
.cal-day {
  aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
  border-radius: 8px; font-size: 13px; font-weight: 500; font-family: var(--font-display); transition: all 0.2s;
}
.cal-day .mins { font-size: 8px; opacity: 0.8; margin-top: -1px; }
.legend { display: flex; gap: 16px; justify-content: center; margin-top: 16px; font-size: 11px; color: var(--muted); }
.legend-dot { display: inline-block; width: 10px; height: 10px; border-radius: 2px; margin-right: 4px; vertical-align: middle; }

/* â”€â”€ Detail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.detail-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
.detail-header .emoji { font-size: 18px; }
.detail-title { font-size: 14px; font-weight: 600; color: var(--fg); }
.detail-sub { font-size: 12px; color: var(--muted); }
.detail-book { font-size: 13px; font-style: italic; color: var(--accent); margin-bottom: 12px; padding: 8px 12px; background: var(--accent-bg); border-radius: 8px; }
.detail-text { font-size: 15px; line-height: 1.75; color: var(--fg); white-space: pre-wrap; }

/* â”€â”€ Thread â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.thread-divider {
  display: flex; align-items: center; gap: 12px; margin: 20px 0 16px;
  font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; font-weight: 600;
}
.thread-divider::before, .thread-divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }
.thread-msg {
  padding: 14px 16px; border-radius: var(--radius); margin-bottom: 10px;
  font-size: 14px; line-height: 1.7; white-space: pre-wrap;
}
.thread-msg.user {
  background: var(--accent-bg); border: 1px solid rgba(196,145,94,0.25);
  color: var(--fg); margin-left: 24px;
}
.thread-msg.ai {
  background: var(--bg2); border: 1px solid var(--border);
  color: var(--fg); margin-right: 24px;
}
.thread-msg-label {
  font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em;
  font-weight: 600; margin-bottom: 6px;
}
.thread-msg.user .thread-msg-label { color: var(--accent); }
.thread-msg.ai .thread-msg-label { color: var(--muted); }
.thread-reply-wrap {
  margin-top: 16px; display: flex; gap: 8px; align-items: flex-end;
}
.thread-input {
  flex: 1; padding: 12px 14px; border-radius: 10px;
  border: 1px solid var(--border); background: var(--bg); color: var(--fg);
  font-size: 14px; font-family: inherit; outline: none; resize: none;
  line-height: 1.5; min-height: 44px; max-height: 120px;
}
.thread-input:focus { border-color: var(--accent); }
.thread-send {
  width: 44px; height: 44px; border-radius: 10px; border: none;
  background: var(--accent); color: #fff; font-size: 18px;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; transition: opacity 0.2s;
}
.thread-send:disabled { opacity: 0.4; cursor: default; }
.thread-thinking {
  display: flex; align-items: center; gap: 8px; padding: 12px 0;
  font-size: 13px; color: var(--muted); font-style: italic;
}

/* â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.settings-note { font-size: 12px; color: var(--muted); line-height: 1.6; margin-top: 8px; }

/* â”€â”€ Animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.fade-in { animation: fadeIn 0.4s ease; }
</style>
</head>
<body>
<div class="shell" id="app">

  <!-- Header -->
  <header class="hdr">
    <button class="hdr-back" id="backBtn" style="display:none" onclick="goBack()">â†</button>
    <div class="hdr-title" id="hdrTitle">Dialectic</div>
    <button class="hdr-settings" onclick="navigate('settings')" title="Settings">âš™</button>
  </header>

  <!-- â•â•â• HOME â•â•â• -->
  <div class="content view active" id="v-home">
    <!-- Today's progress -->
    <div class="card">
      <div class="progress-row">
        <div>
          <div class="card-label">Today's Reading</div>
          <div class="progress-big" id="todayHrs">0<span class="progress-sub" id="todayGoal"> / 2 hrs</span></div>
        </div>
        <div class="progress-ring" id="pctRing">0%</div>
      </div>
      <div class="track"><div class="fill" id="pctFill" style="width:0%;background:var(--amber)"></div></div>
      <div class="streak" id="streakText" style="display:none"></div>
    </div>
    <!-- Log hours -->
    <div class="card" id="logCard">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div class="card-label" style="margin-bottom:0">Log Reading Hours</div>
        <button class="link-btn" id="editLogBtn" style="display:none" onclick="editTodayHours()">Edit today</button>
      </div>
      <div style="display:flex;gap:8px;align-items:flex-end">
        <div style="flex:1">
          <input class="input" id="logHoursInput" type="number" min="0.25" max="24" step="0.25" placeholder="e.g. 1.5" style="font-size:16px">
        </div>
        <button class="primary-btn" style="width:auto;padding:10px 20px;margin-bottom:0" onclick="logHours()">Log</button>
      </div>
      <div style="font-size:11px;color:var(--muted);margin-top:6px">Enter hours read (use decimals: 0.5 = 30 min, 1.5 = 1hr 30min)</div>
    </div>
    <!-- Actions -->
    <div class="actions">
      <button class="action-card" onclick="navigate('record')">
        <span class="emoji">ğŸ™ï¸</span><span class="title">Voice Note</span><span class="sub">Record a reflection</span>
      </button>
      <button class="action-card" onclick="navigate('record')">
        <span class="emoji">âœï¸</span><span class="title">Written Note</span><span class="sub">Type your thoughts</span>
      </button>
    </div>
    <!-- Recent -->
    <div class="section-row" id="recentHeader" style="display:none">
      <div class="section-title">Recent Notes</div>
      <button class="link-btn" onclick="navigate('notes')">See all â†’</button>
    </div>
    <div id="recentList"></div>
    <div class="empty" id="emptyHome" style="display:none">
      <div class="emoji">ğŸ“–</div>
      <div class="title">Start your first note</div>
      <div class="sub">Record a voice or written reflection after reading to sharpen your thinking.</div>
    </div>
  </div>

  <!-- â•â•â• RECORD â•â•â• -->
  <div class="content view" id="v-record">
    <!-- Mode toggle -->
    <div class="toggle-wrap">
      <button class="toggle-btn active" id="tVoice" onclick="setRecordMode('voice')">ğŸ™ï¸ Voice</button>
      <button class="toggle-btn" id="tWritten" onclick="setRecordMode('written')">âœï¸ Written</button>
    </div>
    <!-- Context -->
    <div class="card">
      <label class="input-label">What are you reading?</label>
      <input class="input" id="bookInput" placeholder="e.g. Meditations by Marcus Aurelius, Ch. 4">
    </div>
    <!-- Voice panel -->
    <div id="voicePanel">
      <div class="card">
        <div id="recError"></div>
        <div style="text-align:center;margin-bottom:16px">
          <button class="rec-btn" id="recBtn" style="background:var(--accent)" onclick="toggleRecord()">â—</button>
          <div style="font-size:13px;color:var(--muted);margin-top:8px" id="recStatus">Tap to start recording</div>
        </div>
        <div id="transcriptArea" style="display:none">
          <div class="transcript-box">
            <div class="transcript-label">Transcript</div>
            <div class="transcript-text" id="transcriptText"></div>
          </div>
        </div>
      </div>
    </div>
    <!-- Written panel -->
    <div id="writtenPanel" style="display:none">
      <div class="card">
        <textarea class="textarea" id="writtenInput" placeholder="Write your reflection on what you just readâ€¦" rows="8"></textarea>
      </div>
    </div>
    <!-- Feedback toggle -->
    <div id="preSaveControls">
      <div class="card" style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-size:14px;font-weight:600;color:var(--fg)">Get AI Feedback?</div>
          <div style="font-size:12px;color:var(--muted)">Clarity, logic & comprehension analysis</div>
        </div>
        <button class="fb-toggle on" id="fbToggle" onclick="toggleFeedback()"><div class="knob"></div></button>
      </div>
      <button class="primary-btn" id="saveBtn" disabled onclick="saveNote()">Save Note</button>
    </div>
    <!-- Post-save -->
    <div id="postSave" style="display:none" class="fade-in">
      <div class="card saved-card">
        <div style="font-size:14px;font-weight:600;color:var(--green);margin-bottom:4px">âœ“ Note Saved</div>
        <div style="font-size:13px;color:var(--muted)" id="savedMeta"></div>
      </div>
      <div id="feedbackCard" style="display:none">
        <div class="card feedback-card">
          <div class="feedback-label">AI Feedback</div>
          <div class="feedback-text" id="feedbackText"></div>
        </div>
        <button class="secondary-btn" style="border-color:var(--accent);color:var(--accent)" onclick="continueThread()">
          Continue Thread â†’
        </button>
      </div>
      <div class="btn-row">
        <button class="primary-btn" onclick="resetRecord()">New Note</button>
        <button class="secondary-btn" onclick="navigate('home')">Done</button>
      </div>
    </div>
  </div>

  <!-- â•â•â• CALENDAR â•â•â• -->
  <div class="content view" id="v-calendar">
    <div class="cal-nav">
      <button class="cal-nav-btn" onclick="calPrev()">â€¹</button>
      <div class="cal-month" id="calMonth"></div>
      <button class="cal-nav-btn" onclick="calNext()">â€º</button>
    </div>
    <div class="stats" id="calStats"></div>
    <div class="card" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <div>
        <div style="font-size:13px;font-weight:600;color:var(--fg)">Daily Goal</div>
        <div style="font-size:12px;color:var(--muted)" id="goalDisplay"></div>
      </div>
      <div id="goalControls">
        <button class="link-btn" onclick="editGoal()">Edit</button>
      </div>
    </div>
    <div class="card">
      <div class="cal-grid" id="calGrid"></div>
      <div class="legend">
        <span><span class="legend-dot" style="background:var(--green-bg);border:1px solid var(--green)"></span>Goal met</span>
        <span><span class="legend-dot" style="background:var(--amber-bg);border:1px solid var(--amber)"></span>Partial</span>
        <span><span class="legend-dot" style="background:var(--red-bg);border:1px solid var(--red)"></span>Missed</span>
      </div>
    </div>
  </div>

  <!-- â•â•â• NOTES â•â•â• -->
  <div class="content view" id="v-notes">
    <div id="notesList"></div>
    <div class="empty" id="emptyNotes" style="display:none">
      <div class="emoji">ğŸ“</div><div class="title">No notes yet</div><div class="sub">Your reflections will appear here.</div>
    </div>
  </div>

  <!-- â•â•â• NOTE DETAIL â•â•â• -->
  <div class="content view" id="v-detail"></div>

  <!-- â•â•â• SETTINGS â•â•â• -->
  <div class="content view" id="v-settings">
    <div class="card">
      <label class="input-label">Anthropic API Key (for AI feedback)</label>
      <input class="input" id="apiKeyInput" type="password" placeholder="sk-ant-â€¦" style="margin-bottom:8px">
      <button class="primary-btn" style="margin-top:8px" onclick="saveApiKey()">Save Key</button>
      <div class="settings-note">
        Your key is stored locally on this device only. Get one at
        <a href="https://console.anthropic.com" target="_blank" style="color:var(--accent)">console.anthropic.com</a>.
        Without a key, you can still use voice &amp; written notes â€” just no AI feedback.
      </div>
    </div>
    <div class="card">
      <label class="input-label">Daily Reading Goal (hours)</label>
      <input class="input" id="settingsGoal" type="number" min="0.5" max="24" step="0.5" style="margin-bottom:8px">
      <button class="primary-btn" onclick="saveSettingsGoal()">Update Goal</button>
    </div>
    <div class="card">
      <button class="secondary-btn" style="color:var(--red);border-color:var(--red);margin-bottom:0" onclick="clearAllData()">Clear All Data</button>
      <div class="settings-note">This permanently deletes all notes and calendar data.</div>
    </div>
  </div>

  <!-- Nav -->
  <nav class="nav">
    <button class="nav-btn active" data-view="home" onclick="navigate('home')"><span class="icon">â—‰</span><span class="label">Home</span></button>
    <button class="nav-btn accent-btn" data-view="record" onclick="navigate('record')"><span class="icon">â—</span><span class="label">Record</span></button>
    <button class="nav-btn" data-view="calendar" onclick="navigate('calendar')"><span class="icon">â–¦</span><span class="label">Calendar</span></button>
    <button class="nav-btn" data-view="notes" onclick="navigate('notes')"><span class="icon">â‰¡</span><span class="label">Notes</span></button>
  </nav>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let state = {
  notes: [],
  calendar: {},
  goal: 30,
  apiKey: "",
};
let currentView = "home";
let prevView = "home";
let calYear = new Date().getFullYear();
let calMonth = new Date().getMonth();

// Recording state
let isRecording = false;
let recognition = null;
let recTimer = null;
let recSeconds = 0;
let finalTranscript = "";
let recordMode = "voice";
let wantFeedback = true;
let detailNote = null;
let lastSavedNoteId = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERSISTENCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function load() {
  try { state.notes = JSON.parse(localStorage.getItem("d_notes") || "[]"); } catch { state.notes = []; }
  try { state.calendar = JSON.parse(localStorage.getItem("d_cal") || "{}"); } catch { state.calendar = {}; }
  state.goal = Number(localStorage.getItem("d_goal")) || 2;
  state.apiKey = localStorage.getItem("d_apikey") || "";
}
function save() {
  localStorage.setItem("d_notes", JSON.stringify(state.notes));
  localStorage.setItem("d_cal", JSON.stringify(state.calendar));
  localStorage.setItem("d_goal", String(state.goal));
  localStorage.setItem("d_apikey", state.apiKey);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function navigate(view) {
  prevView = currentView;
  currentView = view;
  document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
  document.getElementById("v-" + view).classList.add("active");

  // Header
  const titles = { home: "Dialectic", record: "New Note", calendar: "Reading Calendar", notes: "All Notes", detail: "Note", settings: "Settings" };
  document.getElementById("hdrTitle").textContent = titles[view] || "Dialectic";
  document.getElementById("backBtn").style.display = view === "home" ? "none" : "block";

  // Nav
  document.querySelectorAll(".nav-btn").forEach(b => {
    b.classList.toggle("active", b.dataset.view === view);
  });

  // Render
  if (view === "home") renderHome();
  if (view === "calendar") renderCalendar();
  if (view === "notes") renderNotes();
  if (view === "detail") renderDetail();
  if (view === "settings") renderSettings();
  if (view === "record") enableSaveBtn();

  window.scrollTo(0, 0);
}
function goBack() {
  if (currentView === "detail") navigate(prevView === "record" ? "home" : "notes");
  else navigate("home");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function todayKey() { return new Date().toISOString().slice(0, 10); }

function getStreak() {
  let streak = 0;
  const d = new Date();
  if ((state.calendar[todayKey()] || 0) < state.goal) d.setDate(d.getDate() - 1);
  while (true) {
    const k = d.toISOString().slice(0, 10);
    if ((state.calendar[k] || 0) >= state.goal) { streak++; d.setDate(d.getDate() - 1); }
    else break;
  }
  return streak;
}

function renderHome() {
  const hrs = state.calendar[todayKey()] || 0;
  const pct = Math.min(100, Math.round((hrs / state.goal) * 100));
  const met = hrs >= state.goal;

  document.getElementById("todayHrs").innerHTML = hrs + `<span class="progress-sub"> / ${state.goal} hrs</span>`;
  const ring = document.getElementById("pctRing");
  ring.textContent = pct + "%";
  ring.style.border = `3px solid ${met ? "var(--green)" : hrs > 0 ? "var(--amber)" : "var(--border)"}`;
  ring.style.color = met ? "var(--green)" : hrs > 0 ? "var(--amber)" : "var(--muted)";
  document.getElementById("pctFill").style.width = pct + "%";
  document.getElementById("pctFill").style.background = met ? "var(--green)" : "var(--amber)";

  // Show edit button if hours logged today
  document.getElementById("editLogBtn").style.display = hrs > 0 ? "inline" : "none";

  const streak = getStreak();
  const st = document.getElementById("streakText");
  if (streak > 0) { st.style.display = "block"; st.textContent = "ğŸ”¥ " + streak + " day streak"; }
  else st.style.display = "none";

  // Recent notes
  const recent = state.notes.slice(0, 3);
  const rh = document.getElementById("recentHeader");
  const rl = document.getElementById("recentList");
  const em = document.getElementById("emptyHome");
  if (recent.length) {
    rh.style.display = "flex";
    rl.innerHTML = recent.map(n => noteCardHTML(n)).join("");
    em.style.display = "none";
  } else {
    rh.style.display = "none";
    rl.innerHTML = "";
    em.style.display = "block";
  }
}

function logHours() {
  const input = document.getElementById("logHoursInput");
  const val = parseFloat(input.value);
  if (!val || val <= 0) return;
  state.calendar[todayKey()] = (state.calendar[todayKey()] || 0) + val;
  // Round to 2 decimal places
  state.calendar[todayKey()] = Math.round(state.calendar[todayKey()] * 100) / 100;
  save();
  input.value = "";
  renderHome();
}

function editTodayHours() {
  const current = state.calendar[todayKey()] || 0;
  const v = prompt("Edit today's reading hours:", current);
  if (v === null) return;
  const num = parseFloat(v);
  if (isNaN(num) || num < 0) return;
  state.calendar[todayKey()] = Math.round(num * 100) / 100;
  save();
  renderHome();
}

function noteCardHTML(n, showDelete) {
  const d = new Date(n.createdAt).toLocaleDateString("en", { month: "short", day: "numeric", hour: "numeric", minute: "2-digit" });
  const badge = n.feedback ? '<span class="badge">Feedback</span>' : '';
  const threadCount = (n.thread && n.thread.length > 0) ? `<span class="badge" style="background:rgba(92,184,92,0.12);color:var(--green)">${Math.ceil(n.thread.length/2)} replies</span>` : '';
  const del = showDelete ? `<button class="del-btn" onclick="event.stopPropagation();deleteNote('${n.id}')">Ã—</button>` : '';
  return `<div class="note-card" onclick="openNote('${n.id}')">
    <div style="display:flex;justify-content:space-between;align-items:flex-start">
      <div style="flex:1">
        <div class="note-meta"><span class="type">${n.type === "voice" ? "ğŸ™ï¸" : "âœï¸"}</span><span class="date">${d}</span>${badge}${threadCount}</div>
        ${n.bookContext ? `<div class="note-book">${esc(n.bookContext)}</div>` : ""}
        <div class="note-preview">${esc(n.text)}</div>
      </div>
      ${del}
    </div>
  </div>`;
}

function esc(s) { const d = document.createElement("div"); d.textContent = s; return d.innerHTML; }

function openNote(id) {
  detailNote = state.notes.find(n => n.id === id);
  if (detailNote) navigate("detail");
}

function deleteNote(id) {
  if (!confirm("Delete this note?")) return;
  state.notes = state.notes.filter(n => n.id !== id);
  save();
  if (currentView === "notes") renderNotes();
  else renderHome();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RECORD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setRecordMode(mode) {
  recordMode = mode;
  document.getElementById("tVoice").classList.toggle("active", mode === "voice");
  document.getElementById("tWritten").classList.toggle("active", mode === "written");
  document.getElementById("voicePanel").style.display = mode === "voice" ? "block" : "none";
  document.getElementById("writtenPanel").style.display = mode === "written" ? "block" : "none";
  enableSaveBtn();
}

function toggleFeedback() {
  wantFeedback = !wantFeedback;
  const btn = document.getElementById("fbToggle");
  btn.className = "fb-toggle " + (wantFeedback ? "on" : "off");
}

function enableSaveBtn() {
  const text = recordMode === "voice" ? finalTranscript.trim() : document.getElementById("writtenInput").value.trim();
  document.getElementById("saveBtn").disabled = text.length < 10;
}

// Voice recording
function toggleRecord() {
  if (isRecording) stopRecord();
  else startRecord();
}

async function startRecord() {
  document.getElementById("recError").innerHTML = "";

  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    document.getElementById("recError").innerHTML = '<div class="error-box">Speech recognition not supported. Use Chrome or Edge, or switch to Written mode.</div>';
    return;
  }

  // Request mic
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    stream.getTracks().forEach(t => t.stop());
  } catch {
    document.getElementById("recError").innerHTML = '<div class="error-box">Microphone access denied. Allow mic permission in your browser and try again, or use Written mode.</div>';
    return;
  }

  recognition = new SR();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = "en-US";

  recognition.onresult = (e) => {
    let interim = "";
    for (let i = e.resultIndex; i < e.results.length; i++) {
      if (e.results[i].isFinal) finalTranscript += e.results[i][0].transcript + " ";
      else interim += e.results[i][0].transcript;
    }
    document.getElementById("transcriptText").textContent = finalTranscript + interim;
    document.getElementById("transcriptArea").style.display = "block";
    enableSaveBtn();
  };

  recognition.onerror = (e) => {
    if (e.error === "not-allowed") {
      document.getElementById("recError").innerHTML = '<div class="error-box">Mic blocked by browser.</div>';
      stopRecord();
    }
  };

  recognition.onend = () => { if (isRecording) try { recognition.start(); } catch {} };

  try { recognition.start(); } catch (err) {
    document.getElementById("recError").innerHTML = '<div class="error-box">Could not start: ' + err.message + '</div>';
    return;
  }

  isRecording = true;
  recSeconds = 0;
  document.getElementById("recBtn").style.background = "var(--red)";
  document.getElementById("recBtn").classList.add("recording");
  document.getElementById("recBtn").textContent = "â– ";
  recTimer = setInterval(() => {
    recSeconds++;
    const m = Math.floor(recSeconds / 60);
    const s = (recSeconds % 60).toString().padStart(2, "0");
    document.getElementById("recStatus").textContent = `Recording ${m}:${s}`;
  }, 1000);
}

function stopRecord() {
  isRecording = false;
  if (recognition) { recognition.onend = null; try { recognition.stop(); } catch {} }
  clearInterval(recTimer);
  document.getElementById("recBtn").style.background = "var(--accent)";
  document.getElementById("recBtn").classList.remove("recording");
  document.getElementById("recBtn").textContent = "â—";
  document.getElementById("recStatus").textContent = "Tap to start recording";
  enableSaveBtn();
}

function resetRecord() {
  finalTranscript = "";
  document.getElementById("transcriptText").textContent = "";
  document.getElementById("transcriptArea").style.display = "none";
  document.getElementById("writtenInput").value = "";
  document.getElementById("bookInput").value = "";
  document.getElementById("recError").innerHTML = "";
  document.getElementById("preSaveControls").style.display = "block";
  document.getElementById("postSave").style.display = "none";
  document.getElementById("saveBtn").disabled = true;
}

async function saveNote() {
  const text = recordMode === "voice" ? finalTranscript.trim() : document.getElementById("writtenInput").value.trim();
  if (text.length < 10) return;

  const book = document.getElementById("bookInput").value.trim();

  let fb = null;
  let cleanedText = text;
  if (wantFeedback) {
    if (!state.apiKey) {
      fb = "No API key set. Go to âš™ Settings to add your Anthropic key for AI feedback.";
    } else {
      document.getElementById("saveBtn").textContent = "Analyzingâ€¦";
      document.getElementById("saveBtn").disabled = true;
      const result = await getAIFeedback(text, book, recordMode === "voice");
      cleanedText = result.cleaned_text || text;
      fb = result.feedback;
    }
  }

  const note = {
    id: Date.now().toString(),
    type: recordMode,
    text: cleanedText,
    rawText: recordMode === "voice" ? text : null,
    bookContext: book,
    feedback: fb,
    wantedFeedback: wantFeedback,
    createdAt: new Date().toISOString(),
  };

  state.notes.unshift(note);
  lastSavedNoteId = note.id;
  save();

  // Show post-save
  document.getElementById("preSaveControls").style.display = "none";
  document.getElementById("voicePanel").style.display = "none";
  document.getElementById("writtenPanel").style.display = "none";
  document.getElementById("savedMeta").textContent = `${text.split(/\s+/).length} words Â· ${recordMode === "voice" ? "voice" : "written"} note`;
  if (fb) {
    document.getElementById("feedbackCard").style.display = "block";
    document.getElementById("feedbackText").textContent = fb;
  } else {
    document.getElementById("feedbackCard").style.display = "none";
  }
  document.getElementById("postSave").style.display = "block";
  document.getElementById("saveBtn").textContent = "Save Note";
}

async function getAIFeedback(text, book, isVoice) {
  try {
    const resp = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-api-key": state.apiKey,
        "anthropic-version": "2023-06-01",
        "anthropic-dangerous-direct-browser-access": "true",
      },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 2000,
        system: `You have two tasks. Separate them using the exact delimiters shown below.

TASK 1 â€” CLEANED TEXT:
${isVoice ? "The input is a raw voice transcript with no punctuation. Add proper punctuation, capitalization, and paragraph breaks. Fix clear speech-to-text errors (e.g. misspelled proper nouns) but keep the user's own words and meaning intact. Do not rephrase." : "Return the user's text unchanged."}

TASK 2 â€” FEEDBACK:
You are a thoughtful reading coach. Your goal is to help the user become a clearer thinker and communicator. Be honest and direct â€” don't sugarcoat problems, but don't be condescending or insulting either. Treat them like an intelligent person who can handle real feedback.

Structure your feedback in three parts, written as flowing paragraphs (not labeled sections):

First, address clarity and communication. Point out specific structural issues, vague language, filler words, false starts, or places where the logic breaks down. Quote the specific phrases that need work and explain why.

Second, find the most promising idea in their reflection and develop it further. Show them where their thinking could go â€” connect it to related concepts, other thinkers, or tensions in the text they're brushing up against. This is where you add intellectual value, not just critique.

Third, offer a perspective they missed. A different reading of the text, a counterargument worth considering, or a context that would deepen their understanding. Frame it as something to think about, not a gotcha.

End with one specific exercise to try next time.

Aim for 250-350 words. Be substantive throughout â€” every sentence should either diagnose a problem, develop an idea, or open a new angle.

FORMAT YOUR RESPONSE EXACTLY LIKE THIS:
===CLEANED===
(the cleaned text here)
===FEEDBACK===
(the feedback here)

Do not include anything before ===CLEANED=== or after the feedback.`,
        messages: [{ role: "user", content: `${book ? `Reading: ${book}\n\n` : ""}Raw note:\n\n"${text}"` }],
      }),
    });
    const data = await resp.json();
    if (data.error) {
      return { cleaned_text: text, feedback: "API Error: " + (data.error.message || JSON.stringify(data.error)) };
    }
    const raw = data.content?.map(b => b.text || "").join("\n") || "";

    // Parse delimiter format
    const cleanedMatch = raw.match(/===CLEANED===\s*([\s\S]*?)\s*===FEEDBACK===/);
    const feedbackMatch = raw.match(/===FEEDBACK===\s*([\s\S]*)/);

    const cleanedText = cleanedMatch ? cleanedMatch[1].trim() : text;
    const feedback = feedbackMatch ? feedbackMatch[1].trim() : raw.trim();

    // If delimiters weren't found at all, just use raw as feedback
    if (!cleanedMatch && !feedbackMatch && raw.length > 50) {
      return { cleaned_text: text, feedback: raw.trim() };
    }

    return { cleaned_text: cleanedText || text, feedback: feedback || "No feedback returned." };
  } catch (e) {
    return { cleaned_text: text, feedback: "Request failed: " + e.message };
  }
}

// Listen for typing in written mode
document.getElementById("writtenInput").addEventListener("input", enableSaveBtn);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALENDAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCalendar() {
  const mName = new Date(calYear, calMonth).toLocaleDateString("en", { month: "long", year: "numeric" });
  document.getElementById("calMonth").textContent = mName;

  const prefix = `${calYear}-${String(calMonth + 1).padStart(2, "0")}`;
  let totalMin = 0, metDays = 0;
  Object.entries(state.calendar).forEach(([k, v]) => {
    if (k.startsWith(prefix)) { totalMin += v; if (v >= state.goal) metDays++; }
  });
  totalMin = Math.round(totalMin * 10) / 10;
  const days = new Date(calYear, calMonth + 1, 0).getDate();

  document.getElementById("calStats").innerHTML = `
    <div class="stat"><div class="stat-val">${totalMin}</div><div class="stat-label">Total Hrs</div></div>
    <div class="stat"><div class="stat-val">${metDays}</div><div class="stat-label">Goals Met</div></div>
    <div class="stat"><div class="stat-val">${days - metDays}</div><div class="stat-label">Missed</div></div>`;

  document.getElementById("goalDisplay").textContent = state.goal + " hours / day";

  const firstDay = new Date(calYear, calMonth, 1).getDay();
  const today = todayKey();
  let grid = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].map(d => `<div class="cal-hdr">${d}</div>`).join("");
  for (let i = 0; i < firstDay; i++) grid += "<div></div>";
  for (let d = 1; d <= days; d++) {
    const key = `${calYear}-${String(calMonth+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const min = state.calendar[key] || 0;
    const isFuture = new Date(calYear, calMonth, d) > new Date();
    const isToday = key === today;
    const met = min >= state.goal;

    let bg = "transparent", color = "var(--fg)", border = "1px solid transparent";
    if (isToday) border = "2px solid var(--accent)";
    if (!isFuture && !isToday) {
      if (met) { bg = "var(--green-bg)"; color = "var(--green)"; }
      else if (min > 0) { bg = "var(--amber-bg)"; color = "var(--amber)"; }
      else { bg = "var(--red-bg)"; color = "var(--red)"; }
    } else if (isToday) {
      if (met) { bg = "var(--green-bg)"; color = "var(--green)"; }
      else if (min > 0) { bg = "var(--amber-bg)"; color = "var(--amber)"; }
    }
    if (isFuture && !isToday) color = "var(--muted)";
    const minsLabel = (min > 0 && !isFuture) ? `<div class="mins">${min}h</div>` : "";
    const clickable = !isFuture || isToday;
    grid += `<div class="cal-day" style="background:${bg};color:${color};border:${border};font-weight:${isToday?700:500};${clickable?'cursor:pointer':''}" title="${min} hrs" ${clickable ? `onclick="editDayHours('${key}')"` : ""}>${d}${minsLabel}</div>`;
  }
  document.getElementById("calGrid").innerHTML = grid;
}

function calPrev() { if (calMonth === 0) { calMonth = 11; calYear--; } else calMonth--; renderCalendar(); }
function calNext() { if (calMonth === 11) { calMonth = 0; calYear++; } else calMonth++; renderCalendar(); }

function editDayHours(dateKey) {
  const current = state.calendar[dateKey] || 0;
  const label = new Date(dateKey + "T12:00:00").toLocaleDateString("en", { month: "short", day: "numeric" });
  const v = prompt(`Hours read on ${label} (current: ${current}):`, current);
  if (v === null) return;
  const num = parseFloat(v);
  if (isNaN(num) || num < 0) return;
  if (num === 0) { delete state.calendar[dateKey]; }
  else { state.calendar[dateKey] = Math.round(num * 100) / 100; }
  save();
  renderCalendar();
  if (dateKey === todayKey()) renderHome();
}

function editGoal() {
  const v = prompt("Set daily reading goal (hours):", state.goal);
  if (v && !isNaN(v) && Number(v) > 0) {
    state.goal = Number(v);
    save();
    renderCalendar();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTES LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderNotes() {
  const el = document.getElementById("notesList");
  const em = document.getElementById("emptyNotes");
  if (state.notes.length === 0) { el.innerHTML = ""; em.style.display = "block"; return; }
  em.style.display = "none";
  el.innerHTML = state.notes.map(n => noteCardHTML(n, true)).join("");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTE DETAIL + THREAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let threadLoading = false;

function renderDetail() {
  if (!detailNote) return;
  const n = detailNote;
  const d = new Date(n.createdAt).toLocaleDateString("en", { weekday: "long", month: "long", day: "numeric", hour: "numeric", minute: "2-digit" });

  let html = `<div class="card">
    <div class="detail-header">
      <span class="emoji">${n.type === "voice" ? "ğŸ™ï¸" : "âœï¸"}</span>
      <div><div class="detail-title">${n.type === "voice" ? "Voice Note" : "Written Note"}</div>
      <div class="detail-sub">${d}</div></div>
    </div>
    ${n.bookContext ? `<div class="detail-book">ğŸ“– ${esc(n.bookContext)}</div>` : ""}
    <div class="detail-text">${esc(n.text)}</div>
    ${n.rawText && n.rawText !== n.text ? `<div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border)"><div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:6px">Raw Transcript</div><div style="font-size:13px;line-height:1.6;color:var(--muted)">${esc(n.rawText)}</div></div>` : ""}
  </div>`;

  // Initial feedback
  if (n.feedback) {
    html += `<div class="card feedback-card"><div class="feedback-label">AI Feedback</div><div class="feedback-text">${esc(n.feedback)}</div></div>`;
  } else if (n.wantedFeedback === false) {
    html += `<div class="card" style="opacity:0.6"><div style="font-size:13px;color:var(--muted);font-style:italic">Feedback was not requested for this note.</div></div>`;
  }

  // Thread messages
  const thread = n.thread || [];
  if (thread.length > 0) {
    html += `<div class="thread-divider">Conversation</div>`;
    for (const msg of thread) {
      const cls = msg.role === "user" ? "user" : "ai";
      const label = msg.role === "user" ? "You" : "Feedback";
      html += `<div class="thread-msg ${cls}"><div class="thread-msg-label">${label}</div>${esc(msg.content)}</div>`;
    }
  }

  // Loading indicator
  if (threadLoading) {
    html += `<div class="thread-thinking" id="threadThinking"><span class="loading-dots">Thinking</span></div>`;
  }

  // Reply box (only if note has feedback â€” thread builds on the dialogue)
  if (n.feedback && state.apiKey) {
    html += `<div class="thread-reply-wrap">
      <textarea class="thread-input" id="threadInput" placeholder="Continue the conversationâ€¦ push back, ask a question, develop an idea" rows="1" oninput="autoGrow(this)" onkeydown="threadKeydown(event)"></textarea>
      <button class="thread-send" id="threadSendBtn" onclick="sendThreadReply()" ${threadLoading ? 'disabled' : ''}>â†‘</button>
    </div>`;
  } else if (n.feedback && !state.apiKey) {
    html += `<div style="text-align:center;padding:12px 0;font-size:13px;color:var(--muted)">Add an API key in âš™ Settings to continue the conversation.</div>`;
  }

  document.getElementById("v-detail").innerHTML = html;

  // Auto-scroll to bottom if thread exists
  if (thread.length > 0 || threadLoading) {
    const el = document.getElementById("v-detail");
    el.scrollTop = el.scrollHeight;
  }

  // Focus input if present
  const input = document.getElementById("threadInput");
  if (input && !threadLoading) input.focus();
}

function autoGrow(el) {
  el.style.height = "auto";
  el.style.height = Math.min(el.scrollHeight, 120) + "px";
}

function threadKeydown(e) {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendThreadReply();
  }
}

async function sendThreadReply() {
  const input = document.getElementById("threadInput");
  if (!input || !input.value.trim() || threadLoading) return;

  const userMsg = input.value.trim();
  const n = detailNote;

  // Init thread array if needed
  if (!n.thread) n.thread = [];
  n.thread.push({ role: "user", content: userMsg });

  // Save immediately so user message appears
  updateNoteInState(n);
  threadLoading = true;
  renderDetail();

  // Build conversation history for API
  const messages = buildThreadMessages(n);

  try {
    const resp = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-api-key": state.apiKey,
        "anthropic-version": "2023-06-01",
        "anthropic-dangerous-direct-browser-access": "true",
      },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 2000,
        system: `You are continuing a conversation about a reading the user did. Your earlier feedback is in the conversation history.

Your role: thoughtful intellectual sparring partner. You're here to help them think deeper, not to score points.

Rules:
- If they push back on your critique, engage seriously. If their counterargument is strong, say so and go deeper. If it has holes, explain specifically where it breaks down.
- If they want to develop an idea, help by asking the right questions and offering connections â€” but don't do the thinking for them. Guide, don't lecture.
- If they ask about the text, share your knowledge but always connect it back to their reflection and where they could take it further.
- Be direct and honest. Skip empty praise, but also skip condescension. Talk to them like an intellectual equal who happens to need a second perspective.
- Introduce tensions, counterpoints, or angles they haven't considered.
- Keep responses 150-250 words unless the complexity demands more.`,
        messages: messages,
      }),
    });

    const data = await resp.json();
    let aiReply = "";
    if (data.error) {
      aiReply = "Error: " + (data.error.message || JSON.stringify(data.error));
    } else {
      aiReply = data.content?.map(b => b.text || "").join("\n") || "No response.";
    }

    n.thread.push({ role: "assistant", content: aiReply });
    updateNoteInState(n);
  } catch (e) {
    n.thread.push({ role: "assistant", content: "Request failed: " + e.message });
    updateNoteInState(n);
  }

  threadLoading = false;
  renderDetail();
}

function buildThreadMessages(n) {
  const msgs = [];

  // First message: the user's original note
  let userFirst = "";
  if (n.bookContext) userFirst += `I just read: ${n.bookContext}\n\n`;
  userFirst += `Here's my reflection:\n\n"${n.text}"`;
  msgs.push({ role: "user", content: userFirst });

  // The initial AI feedback
  if (n.feedback) {
    msgs.push({ role: "assistant", content: n.feedback });
  }

  // Thread messages
  if (n.thread) {
    for (const msg of n.thread) {
      msgs.push({ role: msg.role, content: msg.content });
    }
  }

  return msgs;
}

function updateNoteInState(n) {
  const idx = state.notes.findIndex(x => x.id === n.id);
  if (idx !== -1) {
    state.notes[idx] = n;
    save();
  }
  detailNote = n;
}

function continueThread() {
  if (!lastSavedNoteId) return;
  detailNote = state.notes.find(n => n.id === lastSavedNoteId);
  if (detailNote) navigate("detail");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSettings() {
  document.getElementById("apiKeyInput").value = state.apiKey;
  document.getElementById("settingsGoal").value = state.goal;
}
function saveApiKey() {
  state.apiKey = document.getElementById("apiKeyInput").value.trim();
  save();
  alert("API key saved!");
}
function saveSettingsGoal() {
  const v = Number(document.getElementById("settingsGoal").value);
  if (v > 0) { state.goal = v; save(); alert("Goal updated to " + v + " hrs/day"); }
}
function clearAllData() {
  if (!confirm("Delete ALL notes and reading data? This cannot be undone.")) return;
  state.notes = []; state.calendar = {};
  save();
  navigate("home");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
load();
renderHome();
</script>
</body>
</html>
